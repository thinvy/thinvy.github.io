---
title: 【光流估计2】LK (Lucas-Kanade) 稀疏光流估计算法
author: eren
date: 2023-10-12 23:33:00 +0800
categories: [Blogging]
tags: [robotic_algorithm]
pin: true
math: true
mermaid: true
---

# LK (Lucas-Kanade) 稀疏光流估计算法

> 根据光流估计的三点基本假设，构造优化问题和对应约束

### 亮度不变假设
假设待估计光流的两帧图像的同一物体的亮度不变，这个假设通常是成立的，因为环境光照通常不会发生太大的变化。假设 $t$ 时刻，位于 $(x, y)$ 像素位置的物体，在 $t+Δt$ 时刻位于 $(x+u, y+v)$ 位置，基于亮度不变假设，有:

$$
I(x, y, t)=I\left(x+u, y+v, t+\Delta_{t}\right)
$$

将等式右边进行一阶泰勒展开得:

$$
I\left(x+u, y+v, t+\Delta_{t}\right)=I(x, y, t)+I_{x}^{\prime} u+I_{y}^{\prime} v+I_{t}^{\prime} \Delta_{t}
$$

即有:

$$
\begin{array}{c}
I(x, y, t)=I(x, y, t)+I_{x}^{\prime} u+I_{y}^{\prime} v+I_{t}^{\prime} \Delta_{t} \\
I_{x}^{\prime} u+I_{y}^{\prime} v+I_{t}^{\prime} \Delta_{t}=0
\end{array}
$$

写成矩阵形式有:

$$
\left[I_{x}^{\prime}, I_{y}^{\prime}\right]\left[\begin{array}{l}
u \\
v
\end{array}\right]=-I_{t}^{\prime} \Delta_{t}
$$

其中， $I_{x}^{\prime}$, $I_{y}^{\prime}$  分别为  $(x, y)$  像素点处图像亮度在 $x$ 方向和 $y$ 方向的偏导数，即图像 $x$ 和  $\mathrm{y}$  方向的梯度。$I_{t}^{\prime}$  为 $t$ 时刻 $(x, y)$  处像素亮度对时间的导数，  $I_{t}^{\prime} \Delta_{t}$  即为两图之间的  $(x, y)$  坐标位置的亮度差，表示为  $\Delta I_{t}=I_{t}^{\prime} \Delta_{t}$  。即:

$$
\left[I_{x}^{\prime}, I_{y}^{\prime}\right]\left[\begin{array}{l}
u \\
v
\end{array}\right]=-\Delta I_{t}
$$

给定两张图像，  $I_{x}^{\prime}$, $I_{y}^{\prime}$, $\Delta I_{t}$  均为已知量，  $u, v$  即为待求的光流。上式中建立了一个等式，存在两个未知数  $(u, v)$  ，无法得到唯一解。因此，需要借助邻域光流相似假设。

### 邻域光流相似假设
以像素点  $(x, y)$  为中心，设定  $3 \times 3$  的邻域（以  $3 \times 3$  举例，也可以是其他的大小)，假设该邻域内的所有像素点光流值一致，通常一个小的图像区域里像素移动方向 和大小是基本一致的，因此这个假设也是合理的。借助该假设，领域内的所有像素根据上面亮度不变约束的等式，得:

$$
\left[\begin{array}{c}
I_{x}^{\prime(1)}, I_{y}^{\prime(1)} \\
I_{x}^{\prime(2)}, I_{y}^{\prime(2)} \\
\cdots \\
I_{x}^{\prime(n)}, I_{y}^{\prime(n)}
\end{array}\right]\left[\begin{array}{c}
u \\
v
\end{array}\right]=\left[\begin{array}{c}
-\Delta I_{t}^{(1)} \\
-\Delta I_{t}^{(2)} \\
\cdots \\
-\Delta I_{t}^{(n)}
\end{array}\right]
$$

上式即为  $A x=b$  的形式，可求得光流  $x=(u, v)$  的最小二乘解:

$$
x=\left(A^{T} A\right)^{-1} A^{T} b
$$

其中，要求  $\left(A^{T} A\right)$  可逆，如果  $\left(A^{T} A\right)$  不可逆，上式将出现多解，即出现孔径问题 (Aperture Problem)，如下图所示，从圆孔中观察三种移动的条纹的变化，是一致的，从而无 法通过圆孔得到条纹的真实移动方向 (光流方向)。因此，Lucas-Kanade方法将选取一些  $\left(A^{T} A\right)$  可逆的像素点估计光流，这些点是一些亮度变化明显的角点，知名的角点检测算法Harris 角点检测算法正是借助了  $\left(A^{T} A\right)$  可逆的相关性质。

![光流求解的孔径问题](https://pic1.zhimg.com/v2-db0e97ab2419a7a3399b106b21ee0064_b.webp)


除了基于亮度不变假设和邻域光流相似假设，为了解决图像偏移较大的情况，Lucas-Kanade算法还借助了图像金字塔（Pyramid）的方式，在高层低分辨率图像上，大的偏移将变为小的偏移。最终，Lucas-Kanade方法给出了一种求解稀疏（明显特征的角点）光流的方法。
