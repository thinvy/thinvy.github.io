---
title: 【光流估计1】光流估计算法综述
author: eren
date: 2023-10-12 22:33:00 +0800
categories: [Blogging]
tags: [robotic_algorithm]
pin: true
math: true
mermaid: true
---

# 光流估计算法综述

### 光流
  **光流（optical flow）是空间运动物体在观察成像平面**上的**像素运动**的**瞬时速度**。

 光流法是利用图像序列中像素在时间域上的变化以及相邻帧之间的相关性来找到上一帧跟当前帧之间存在的对应关系，从而计算出**相邻帧之间物体的运动信息**的一种方法。

一般而言，光流是由于场景中 前景目标本身的移动、相机的运动，或者两者的共同运动所产生的。

光流在SLAM前端、视频inpainting、视频压缩编码、视频防抖等领域都发挥了重要的作用。

### 光流矢量

将**二维图像平面特定坐标点**上的**灰度瞬时变化率**定义为**光流矢量**。

![img](https://github.com/Liber-coder/CV_Notes/raw/master/3D_Vision/.markdown.images/20180909205551998-1595427519843.png)

如上图所示，三维空间内物体的运动在二维成像平面上的投影。得到的是一个描述位置变化的二维矢量，但在运动间隔极小的情况下，我们通常将其视为一个描述该点瞬时速度的二维矢量u=(u,v)，即光流矢量。

### 光流场
 在空间中，运动可以用运动场描述，而在一个图像平面上，物体的运动往往是通过图像序列中不同图像灰度分布的不同体现的，从而，**空间中的运动场**转移到图像上就表示为**光流场（optical flow field）**。

 光流场是是很多光流矢量的集合，它是一个**二维矢量场**，反映了图像上每一点**灰度的变化趋势**，可看成是**带有灰度的像素点**在图像平面上运动而产生的**瞬时速度场**。它包含的信息即是各像点的瞬时运动速度矢量信息。

 研究光流场的目的就是**为了从序列图像中近似计算不能直接得到的运动场**。光流场在理想情况下，光流场对应于运动场。


### 光流估计算法综述
一般来说，对光流的估计算法要基于下面几种假设：

- 亮度恒定，三维空间中同一点随着时间的变化，其亮度不会发生改变。这是基本光流法的假定（所有 光流法变种都必须满足），用于得到光流法基本方程。
- 小运动，即时间的变化不会引起位置的剧烈变化，这样灰度才能对位置求偏导（换句话说，小运动情 况下我们才能用前后帧之间单位位置变化引起的灰度变化去近似灰度对位置的偏导数），这也是光流 法不可或缺的假设。
- 空间一致（Lucas-Kanade 光流法特有的假定），一个场景上邻近的点投影到图像上也是邻近点，且邻近点速度一致。注意一般的光流法基本方程约束只有一个，而要求 x，y 方向的速度会有两个未知 量。我们假定特征点邻域内做相似运动，就可以连立 n 多个方程求取 x，y 方向的速度（n 为特征点邻域总点数，包括该特征点）。

光流估计可以笼统地分为两大类
- 稠密光流估计：只针对图像中的指定像素（特征点）进行跟踪
- 稀疏光流估计：对图像中的每一个像素（或均匀降采样的每一个像素）进行跟踪

```HTML

<video width="320" height="240" controls>

<source src="https://vdn3.vzuu.com/SD/8ebddefe-ec52-11ea-acfd-5ab503a75443.mp4?disable_local_cache=1&bu=078babd7&c=avc.0.0&f=mp4&expiration=1697123908&auth_key=1697123908-0-0-ae6b0770292ed170bc267a2f8359efb7&v=tx&pu=078babd7" type="video/mp4">

</video>
```
#### 稠密光流估计综述（传统方法）
稠密光流估计中跟踪的像素点数量远多于稀疏光流，因此理论上其准确性和鲁棒性要强于稀疏光流，但代价是巨大的计算量。传统算法主要有：
- Horn-Schunck 方法：Horn 和 Schunck 于 1981 年提出。此方法是首次使用亮度恒定假设和推导出基 本的亮度恒定方程的方法之一。OpenCV 中的 cvCalcOpticalFlowHS 即为该方法的实现。 
- 块匹配方法，对像素的集合进行处理而非单个像素，返回的“速度图像”通常比输入图像分辨率低。 OpenCV 中的 cvCalcOpticalFlowBM 即为该方法的实现。

这两种光流方法现在并不常用，而且它们不支持图像金字塔匹配而不能用于跟踪大幅度的运动。 实际上计算稠密光流并不容易，比如一张白纸的运动，上一帧中的白色的像素在下一帧中仍然为白色， 因此很难寻找该白纸上任一点的前后帧之间的对应点。


#### 稀疏光流估计综述

稀疏光流估计中指定的像素点最好具有某种明显的特性，例如角点（关键点），那么跟踪就会相对稳定和可靠。稀疏跟踪的计算开销比稠密跟踪小得多。 

常见的稀疏光流跟踪方法： 
- Lucas-Kanade(LK) 光流法：于 1981 年提出，最初是用于求稠密光流的，由于算法易于应用在输入 图像的一组点上，而成为求稀疏光流的一种重要方法。 
- 金字塔 LK 光流法：LK 光流法有个“小运动”的假设，因此较大运动会将点移出小窗口，造成算法 无法再找到这些点。金字塔 LK 光流法可以解决这个问题，即从金字塔的最高层（细节最少）开始向金字塔的低层（丰富的细节）进行跟踪，该方法允许小窗口捕获较大的运动。

 使用 python 的 OpenCV 时，调用 cv2.calcOpticalFlowPyrLK 就可以进行稀疏光流估计。

#### 稠密光流估计网络
光流估计问题可以被一个端到端的神经网络解决，输入是两张图像，输出是一张光流场的估计图。（双目深度估计网络和它极其类似）

光流网络训练的损失函数通常是端点误差函数 (End Point Error Loss)，即加和每个像素点预测的光流与标注的二维空间欧式距离。但稠密光流的手动标注很难，此类网络开山之作Flownet的作者也对此提出了解决方案。

目前对于稠密光流的估计，NN方案已成为主流，其被广泛很多基于视频序列的神经网络中。


参考文献：
https://dezeming.top/wp-content/uploads/2023/03/%E5%85%89%E6%B5%81%E4%BC%B0%E8%AE%A1%E5%85%A5%E9%97%A8.pdf
推荐阅读：
https://www.zhihu.com/tardis/zm/art/151741828?source_id=1003
